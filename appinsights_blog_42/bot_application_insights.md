# Telemetry with Bot Framework 4.2

## Summary
In version 4.2 of the Bot Framework SDK, telemetry logging was added into the product.  This enables Bot applications to send event data to services such as Application Insights.

This document covers how to integrate your bot with the new telemetry features.  

## Using Bot Configuration (Option 1 of 2)
There are two methods of configuring your bot.  The first assumes you are integrating with Application Insights.

The bot configuration file contains metadata about external services the Bot uses while running.  For example, CosmosDB, Application Insights and the Language Understanding (LUIS) service connection and metadata is stored here.   

If you want "stock" Application Insights, with no additional Application Insights-specific configuration required (for example Telemetry Initializers), pass in the bot configuration object during initialization.   This is the easiest method to initialize and will configure Application Insights to begin tracking Requests, external calls to other services, and correlating events across services.

>ASP.Net Core - Startup.cs
```csharp
public void ConfigureServices(IServiceCollection services)
{
     ...
     // Add Application Insights - pass in the bot configuration
     services.AddBotApplicationInsights(botConfig);
     ...
public void Configure(IApplicationBuilder app, IHostingEnvironment env)
{
     app.UseBotApplicationInsights()
                 ...
                .UseDefaultFiles()
                .UseStaticFiles()
                .UseBotFramework();
```
>Node.js
```js
const appInsightsClient = new ApplicationInsightsTelemetryClient(botConfig);
```

**No Application Insights in Bot Configuration**
What if your bot configuration doesn't contain Application Insights?  No problem, it defaults to a null client which no-ops the method calls.

**Multiple Application Insights**
Have multiple Application Insight sections in your bot configuration?  You can designate which instance of the Application Insights service you want to use inside your bot configuration.

>ASP.Net Core
```csharp
public void ConfigureServices(IServiceCollection services)
{
     // Add Application Insights
     services.AddBotApplicationInsights(botConfig, "myAppInsights");
```
>Node.js
```js
const appInsightsClient = new ApplicationInsightsTelemetryClient(botConfig);
```



## Overriding the Telemetry Client (Option 2 of 2)

If you want to customize your Application Insights client, or you want to log into a completely separate service, you have to configure the system differently.

**Modify Application Insights Configuration**
> ASP.Net Core
```
csharp
public void ConfigureServices(IServiceCollection services)
{
     ...
     // Create Application Insight Telemetry Client
     // with custom configuration.
     var telemetryClient = TelemetryClient(myCustomConfiguration)
     
     // Add Application Insights
     services.AddBotApplicationInsights(new BotTelemetryClient(telemetryClient), "InstrumentationKey");
```
>Node.js
```js
const appInsightsClient = new ApplicationInsightsTelemetryClient(botConfig);
```

**Use Custom Telemetry**
If you want to log telemetry events generated by the Bot Framework into a completely separate system, create a new class derived from the base interface and configure.  



> ASP.Net Core
```
csharp
public void ConfigureServices(IServiceCollection services)
{
     ...
     // Create my IBotTelemetryClient-based logger
     var myTelemetryClient = MyTelemetryLogger();
     
     // Add Application Insights
     services.AddBotApplicationInsights(myTelemetryClient);
```
>Node.js
```js
const appInsightsClient = new ApplicationInsightsTelemetryClient(botConfig);
```


### Identifiers Added to Custom Events

A new Application Insights Telemetry Initializer modifies the values of the standard Application Insights  `user_id` and `session_id`.  The values are from the bot's payload data.

In addition, `activitiId`, `activityType` and `channelId` are also added.

>Note: Custom telemetry clients will not be provided these values.

Property |Type | Details
--- | --- | ---
`user_id`| `string` | [ChannelID](https://github.com/Microsoft/botframework-obi/blob/master/botframework-activity/botframework-activity.md#channel-id) + [From.Id](https://github.com/Microsoft/botframework-obi/blob/master/botframework-activity/botframework-activity.md#from)
`session_id`| `string`|  [ConversationID](https://github.com/Microsoft/botframework-obi/blob/master/botframework-activity/botframework-activity.md#conversation)
`customDimensions.activityId`| `string` | [The bot activity ID](https://github.com/Microsoft/botframework-obi/blob/master/botframework-activity/botframework-activity.md#id)
`customDimensions.activityType` | `string` | [The bot activity type ](https://github.com/Microsoft/botframework-obi/blob/master/botframework-activity/botframework-activity.md#channel-id)
`customDimensions.channelId` | `string` |  [The bot activity channel ID ](https://github.com/Microsoft/botframework-obi/blob/master/botframework-activity/botframework-activity.md#channel-id)


## Events Generated from SDK

The following section describes the events generated from within the Bot Framework.

### CustomEvent: "WaterfallStart" 

When a WaterfallDialog begins, a `WaterfallStart` event is logged.

- `user_id`  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `session_id` ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `customDimensions.activityId`  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `customDimensions.activityType`  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `customDimensions.channelId` ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `customDimensions.DialogId` (This is the dialogId (string) passed into your Waterfall.  You can consider this the "waterfall type")
- `customDimensions.InstanceID` (unique per instance of the dialog)


### CustomEvent: "WaterfallStep" 

Logs individual steps from a Waterfall Dialog.

- `user_id`  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `session_id` ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `customDimensions.activityId`  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `customDimensions.activityType`  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `customDimensions.channelId` ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `customDimensions.DialogId` (This is the dialogId (string) passed into your Waterfall.  You can consider this the "waterfall type")
- `customDimensions.StepName` (either method name or `StepXofY` if lambda)
- `customDimensions.InstanceID` (unique per instance of the dialog)



### CustomEvent: "WaterfallDialogComplete"

Logs when a Waterfall Dialog completes.

- `user_id`  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `session_id` ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `customDimensions.activityId`  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `customDimensions.activityType`  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `customDimensions.channelId` ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `customDimensions.DialogId` (This is the dialogId (string) passed into your Waterfall.  You can consider this the "waterfall type")
- `customDimensions.InstanceID` (unique per instance of the dialog)



### CustomEvent: "WaterfallDialogCancel" 

Logs when a Waterfall Dialog is canceled.

- `user_id`  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `session_id` ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `customDimensions.activityId`  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `customDimensions.activityType`  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `customDimensions.channelId` ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- `customDimensions.DialogId` (This is the dialogId (string) passed into your Waterfall.  You can consider this the "waterfall type")
- `customDimensions.StepName` (either method name or `StepXofY` if lambda)
- `customDimensions.InstanceID` (unique per instance of the dialog)

## Events generated with Enterprise Template
The [Enterprise Template](https://github.com/Microsoft/AI/tree/master/templates/Enterprise-Template) is open source code that can be freely copied. 

### CustomEvent: BotMessageReceived (IpaBotMessageReceived)
**Logged From:** TelemetryLoggerMiddleware (**Enterprise Sample**)

Logged when bot receives new message.

- UserID  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- ConversationID ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- ActivityID  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- Channel  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- ActivityType  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- Text (Optional for PII)
- FromId
- FromName
- RecipientId
- RecipientName
- ConversationId
- ConversationName
- Locale

### CustomEvent: BotMessageSend (IpaBotMessageSent)
**Logged From:** TelemetryLoggerMiddleware (**Enterprise Sample**)

Logged when bot sends a message.

- UserID  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- ConversationID ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- ActivityID  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- Channel  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- ActivityType  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- ReplyToID
- Channel  (Source channel - e.g. Skype, Cortana, Teams)
- RecipientId
- ConversationName
- Locale
- Text (Optional for PII)
- RecipientName (Optional for PII)



~~### CustomEvent: BotMessageUpdate~~
~~**Logged From:** TelemetryLoggerMiddleware~~
~~Logged when a message is updated by the bot (rare case)~~

~~### CustomEvent: BotMessageDelete~~
~~**Logged From:** TelemetryLoggerMiddleware~~
~~Logged when a message is deleted by the bot (rare case)~~



### CustomEvent: LuisIntent.INENTName (LUISResult)
**Logged From:** TelemetryLuisRecognizer (**Enterprise Sample**)

Logs results from LUIS service.

- UserID  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- ConversationID ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- ActivityID  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- Channel  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- ActivityType  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- Intent
- IntentScore
- Question
- ConversationId
- SentimentLabel
- SentimentScore
- *LUIS entities*
- **NEW** DialogId


### CustomEvent: QnAMessage
**Logged From:** TelemetryQnaMaker (**Enterprise Sample**)

Logs results from QnA Maker service.

- UserID  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- ConversationID ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- ActivityID  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- Channel  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- ActivityType  ([From Telemetry Initializer](#identifiers-added-to-custom-events))
- Username
- ConversationId
- OriginalQuestion
- Question
- Answer
- Score (*Optional*: if we found knowledge)



**NEW**




~~### CustomEvent: "Activity"~~
~~**Logged From:** Channel Service~~
~~Logged by the Channel Service when a message received.~~

~~### Exception: Bot Errors~~
~~**Logged From:** Channel Service~~
~~Logged by the channel when a call to the Bot returns a non-2XX Http Response.~~


# Usage Metrics for Virtual Assistant

Item |Type | Description
--- | --- | ---
Number of users who have enabled or registered VA | User Activity | Assumption: The registration process contains a Waterfall dialog.  This will be the count of events for the WaterfallDialogConvert event
Number of Active (Engaged) VA users | User Activity | Distinct count of BotMessageReceived events on UserID
Number of Anonymous Users | User Activity | Distinct count of BotMessageReceived events on UserID minus Registered Users.
Number of new registerations | User Activity | Count of WaterfallDialogConvert events for the registeration dialog.
Average number of sessions per user | Engagment | BotMessageReceived : UserID by SessionID
Average time spent per session | Engagement |Based on  BotMessageReceived 
Average # of skills per person  | Engagement |Based on WaterfallDialogStep distinct on UserID
Average number of interactions per user | Engagement |Based on BotMessageReceived
Number of Skills (per Region/Language/etc) | Engagement | Based on BotMessageReceived
Number of abandoned/cancelled Skills (last N sessions) | Churn | Based on WaterfallDialogCancel
Common (high frequency) abandoned/cancelled skills | Churn | WaterfallDialogStep / WaterfallDialogCancel
Skills with high interaction acount | Churn | WaterfallDialogStep



# Conversational Metrics for Virtual Assistant

Item |Type | Description
--- | --- | ---
Most popular/least popular skills | Skills Insight | WaterfallDialogStep
Skills take a long time to complete | Skills Insight | WaterfallDialogStep / WaterfallDialogComplete
Average number of Interations per skill | Skills Insight | WaterfallDialogStep / WaterfallDialogComplete
Duration of each stage | Skills Insight | WaterfallDialogStep
Skills that take higher interactions | Skills Insight | WaterfallDialogStep
Count user OK with recommendations | Skills Insight | ? Custom Event
Missed / retried utterance | Skills Insight | LuisIntent.INENTName 
Skill successfully handled by IPA | Skills Insight | WaterfallDialogConvert
Skill transferred to Agent | Skills Insight | ? Custom Event
Number of times Skill Completed/Cancelled/Abandoned | Skills Insight | WaterfallDialogCancel / WaterfallDialogComplete / WaterfallDialogStep
Cancel / Abandon Correlation: Duration | Skills Insight | WaterfallDialogStep
Cancel / Abandon Correlation: Too many messages | Skills Insight | WaterfallDialogStep 
Cancel / Abandon Correlation: Retry | Skills Insight | WaterfallDialogStep
Cancel / Abandon Correlation: Not happy | Skills Insight | Sentiment LuisIntent.INENTName


# Machine Learning for Virtual Assistant
***PRI2 Not in scope for 4.2** 

Item |Type | Description
--- | --- | ---
Identify user unsubscribe | Churn | ? Custom Event for Unsubscribe?  Otherwise look-alike model
Identify user abandon | Churn | ? Assume abandon defined by duration.  Look-alike model
Identify low consumption | Churn | Look-alike model
User preference | Recommendations | ? LUIS entities / intents? Look-alike? Need more information 
Buy new product in future | Sales/Marketing | LUIS entities / Qna?

# Application Insights Requirements
- Be able to override IBotTelemetryClient (NullBotTelemetryCiient)
  - Custom TelemetryClient (from override IBotTelemetryClient) 	
- Be able to override ILogger
- Initialize with Bot Configuration
